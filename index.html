<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Icone</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000 url("sfondo.jpg") center center fixed no-repeat;
      background-size: cover;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 10px;
      text-shadow: 0 0 5px #000;
	  color: yellow;
    }

    .panel {
      background: rgba(0, 0, 0, 0.65);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      max-width: 550px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 14px;
    }

    input[type="file"],
    input[type="range"],
    button {
      width: 100%;
      box-sizing: border-box;
    }

    button {
      padding: 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: #555;
      color: #fff;
      transition: background 0.2s;
    }

    button:hover {
      background: #777;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    .small {
      font-size: 12px;
      color: #ddd;
    }

    #canvasContainer {
      margin-top: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
    }

    canvas {
      background: #222;
      border-radius: 4px;
      image-rendering: pixelated;
      max-width: 400px;
      max-height: 400px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .row > * {
      flex: 1 1 150px;
    }
  </style>

  <!-- Favicon -->
  <link rel="icon" href="favicon.png" type="image/png">
</head>
<body>
  <h1>Crea le tue icone</h1>

  <div class="panel">
    <label>
      1) Carica la tua immagine:
      <input type="file" id="fileInput" accept="image/*">
    </label>

    <label>
      2) Soglia per il nero/bianco:
      <span id="thresholdValue">20%</span>
      <input type="range" id="threshold" min="0" max="80" value="10">
      <span class="small">
        Valore più alto = considera più colori come "nero" o "bianco".<br>
        Per sfondo pieno spesso basta 10–25.
      </span>
    </label>

    <div class="row">
      <button id="removeBgBtn" disabled>3) Rimuovi sfondo nero/bianco</button>
    </div>

    <div class="row">
      <button id="downloadPngBtn" disabled>4) Scarica PNG trasparente</button>
      <button id="downloadIcoBtn" disabled>5) Scarica ICO 256×256</button>
    </div>

    <span class="small">
    </span>
  </div>

  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const thresholdInput = document.getElementById('threshold');
    const thresholdValueSpan = document.getElementById('thresholdValue');

    const removeBgBtn = document.getElementById('removeBgBtn');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const downloadIcoBtn = document.getElementById('downloadIcoBtn');

    let img = null;
    let imageLoaded = false;

    function resetCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Aggiorna etichetta percentuale
    function updateThresholdLabel() {
      thresholdValueSpan.textContent = thresholdInput.value + '%';
    }

    thresholdInput.addEventListener('input', updateThresholdLabel);
    updateThresholdLabel(); // iniziale

    // Carica immagine
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          resetCanvas();
          ctx.drawImage(img, 0, 0);
          imageLoaded = true;

          removeBgBtn.disabled = false;
          downloadPngBtn.disabled = false;
          downloadIcoBtn.disabled = false;
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Rimuovi sfondo nero e bianco
    removeBgBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const threshold = parseInt(thresholdInput.value, 10);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        if (a === 0) continue;

        const isBlack =
          r <= threshold &&
          g <= threshold &&
          b <= threshold;

        const isWhite =
          r >= 255 - threshold &&
          g >= 255 - threshold &&
          b >= 255 - threshold;

        if (isBlack || isWhite) {
          data[i + 3] = 0; // trasparente
        }
      }

      ctx.putImageData(imageData, 0, 0);
      alert('Sfondo nero/bianco reso trasparente!');
    });

    // Scarica PNG trasparente
    downloadPngBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = 'icon_transparent.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Scarica ICO (contiene un PNG 256×256 con trasparenza)
    downloadIcoBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const size = 256;
      const outCanvas = document.createElement('canvas');
      outCanvas.width = size;
      outCanvas.height = size;
      const octx = outCanvas.getContext('2d');

      octx.clearRect(0, 0, size, size);

      const srcW = canvas.width;
      const srcH = canvas.height;
      const srcAspect = srcW / srcH;

      let drawW, drawH, offX, offY;

      if (srcAspect > 1) {
        drawW = size;
        drawH = size / srcAspect;
      } else {
        drawH = size;
        drawW = size * srcAspect;
      }

      offX = (size - drawW) / 2;
      offY = (size - drawH) / 2;

      octx.drawImage(canvas, 0, 0, srcW, srcH, offX, offY, drawW, drawH);

      const pngDataURL = outCanvas.toDataURL('image/png');
      const pngBytes = dataURLToUint8Array(pngDataURL);

      const icoBuffer = createIcoFromPng(pngBytes, size, size);
      const blob = new Blob([icoBuffer], { type: 'image/x-icon' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'icon_256.ico';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    function dataURLToUint8Array(dataURL) {
      const base64 = dataURL.split(',')[1];
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function createIcoFromPng(pngBytes, width, height) {
      const pngSize = pngBytes.length;
      const icoSize = 6 + 16 + pngSize;
      const buffer = new ArrayBuffer(icoSize);
      const view = new DataView(buffer);

      // ICONDIR
      view.setUint16(0, 0, true);   // idReserved
      view.setUint16(2, 1, true);   // idType = 1 (ICO)
      view.setUint16(4, 1, true);   // idCount = 1

      // ICONDIRENTRY
      view.setUint8(6, width === 256 ? 0 : width);   // bWidth
      view.setUint8(7, height === 256 ? 0 : height); // bHeight
      view.setUint8(8, 0);                           // bColorCount
      view.setUint8(9, 0);                           // bReserved
      view.setUint16(10, 1, true);                   // wPlanes
      view.setUint16(12, 32, true);                  // wBitCount
      view.setUint32(14, pngSize, true);             // dwBytesInRes
      view.setUint32(18, 6 + 16, true);              // dwImageOffset

      const byteArray = new Uint8Array(buffer, 22);
      byteArray.set(pngBytes);

      return buffer;
    }
  </script>
</body>
</html>
