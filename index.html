<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Icone</title>

  <!-- Mobile / Android -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #000 url("sfondo.jpg") center center fixed no-repeat;
      background-size: cover;
      color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: stretch;
      overflow: hidden; /* niente scroll */
    }

    .app {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }

    /* Banner in alto */
    .top-banner {
      background: #66cfff;           /* celeste */
      color: #ffd800;                /* giallo */
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 4px #000;
      padding: 6px 4px;
      font-size: 4.2vw;
      flex: 0 0 auto;
    }

    /* Footer in basso */
    .bottom-footer {
      background: #66cfff;           /* celeste */
      color: #ffd800;                /* giallo */
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 4px #000;
      padding: 6px 4px;
      font-size: 4vw;
      flex: 0 0 auto;
    }

    /* Area centrale */
    .content {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 6px 8px;
      box-sizing: border-box;
      gap: 6px;
    }

    .logo {
      max-height: 10vh;
      max-width: 40vw;
      object-fit: contain;
    }

    h1 {
      font-size: 4vw;
      margin: 2px 0 4px;
      text-shadow: 0 0 5px #000;
      text-align: center;
    }

    .panel {
      background: rgba(0, 0, 0, 0.65);
      padding: 8px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      max-width: 95vw;
      width: 95vw;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-sizing: border-box;
      flex: 0 0 auto;
    }

    label {
      font-size: 3.3vw;
      display: block;
    }

    input[type="file"],
    input[type="range"],
    button {
      width: 100%;
      box-sizing: border-box;
    }

    input[type="file"],
    input[type="range"] {
      margin-top: 3px;
    }

    button {
      padding: 6px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 3.4vw;
      background: #555;
      color: #fff;
      transition: background 0.2s;
    }

    button:hover {
      background: #777;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    .small {
      font-size: 3vw;
      color: #ddd;
    }

    #canvasContainer {
      margin-top: 4px;
      background: rgba(0, 0, 0, 0.7);
      padding: 6px;
      border-radius: 10px;
      max-width: 95vw;
      width: 95vw;
      box-sizing: border-box;
      flex: 1 1 auto;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      background: #222;
      border-radius: 4px;
      image-rendering: pixelated;
      max-width: 100%;
      max-height: 100%;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .row > * {
      flex: 1 1 45%;
    }
  </style>

  <!-- Favicon -->
  <link rel="icon" href="favicon.png" type="image/png">
</head>
<body>
  <div class="app">
    <!-- Banner superiore -->
    <div class="top-banner">
      BENVENUTO
    </div>

    <!-- Contenuto centrale -->
    <div class="content">
      <!-- Logo -->
      <img src="logo.png" alt="Logo" class="logo">

      <h1>Crea le tue icone</h1>

      <div class="panel">
        <label>
          1) Carica immagine :
          <input type="file" id="fileInput" accept="image/*">
        </label>

        <label>
          2) Soglia per il nero/bianco:
          <span id="thresholdValue">10%</span>
          <input type="range" id="threshold" min="0" max="80" value="10">
          <span class="small">
            Valore più alto = considera più colori come "nero" o "bianco".<br>
            Per sfondo pieno spesso basta 10–25.
          </span>
        </label>

        <div class="row">
          <button id="removeBgBtn" disabled>3) Rimuovi sfondo nero/bianco</button>
        </div>

        <div class="row">
          <button id="downloadPngBtn" disabled>4) Scarica PNG trasparente</button>
          <button id="downloadIcoBtn" disabled>5) Scarica ICO 256×256</button>
        </div>

        <span class="small">
          Flusso: carica immagine → rimuovi sfondo nero/bianco → scarica PNG o ICO.
        </span>
      </div>

      <div id="canvasContainer">
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <!-- Footer inferiore -->
    <div class="bottom-footer">
      GIOVANNI E STELLA
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const thresholdInput = document.getElementById('threshold');
    const thresholdValueSpan = document.getElementById('thresholdValue');

    const removeBgBtn = document.getElementById('removeBgBtn');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const downloadIcoBtn = document.getElementById('downloadIcoBtn');

    let img = null;
    let imageLoaded = false;

    function resetCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Adatta il canvas allo spazio disponibile nel container
    function fitCanvasToContainer(imgWidth, imgHeight) {
      const container = document.getElementById('canvasContainer');
      const maxW = container.clientWidth * 0.95;
      const maxH = container.clientHeight * 0.95;

      const scale = Math.min(maxW / imgWidth, maxH / imgHeight, 1);

      canvas.width  = imgWidth * scale;
      canvas.height = imgHeight * scale;
    }

    // Aggiorna etichetta percentuale
    function updateThresholdLabel() {
      thresholdValueSpan.textContent = thresholdInput.value + '%';
    }

    thresholdInput.addEventListener('input', updateThresholdLabel);
    updateThresholdLabel(); // iniziale

    // Carica immagine
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        img = new Image();
        img.onload = () => {
          fitCanvasToContainer(img.width, img.height);
          resetCanvas();
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          imageLoaded = true;

          removeBgBtn.disabled = false;
          downloadPngBtn.disabled = false;
          downloadIcoBtn.disabled = false;
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Rimuovi sfondo nero e bianco
    removeBgBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const threshold = parseInt(thresholdInput.value, 10);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        if (a === 0) continue;

        const isBlack =
          r <= threshold &&
          g <= threshold &&
          b <= threshold;

        const isWhite =
          r >= 255 - threshold &&
          g >= 255 - threshold &&
          b >= 255 - threshold;

        if (isBlack || isWhite) {
          data[i + 3] = 0; // trasparente
        }
      }

      ctx.putImageData(imageData, 0, 0);
      alert('Sfondo nero/bianco reso trasparente!');
    });

    // Scarica PNG trasparente
    downloadPngBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = 'icon_transparent.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Scarica ICO (contiene un PNG 256×256 con trasparenza)
    downloadIcoBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      const size = 256;
      const outCanvas = document.createElement('canvas');
      outCanvas.width = size;
      outCanvas.height = size;
      const octx = outCanvas.getContext('2d');

      octx.clearRect(0, 0, size, size);

      const srcW = canvas.width;
      const srcH = canvas.height;
      const srcAspect = srcW / srcH;

      let drawW, drawH, offX, offY;

      if (srcAspect > 1) {
        drawW = size;
        drawH = size / srcAspect;
      } else {
        drawH = size;
        drawW = size * srcAspect;
      }

      offX = (size - drawW) / 2;
      offY = (size - drawH) / 2;

      octx.drawImage(canvas, 0, 0, srcW, srcH, offX, offY, drawW, drawH);

      const pngDataURL = outCanvas.toDataURL('image/png');
      const pngBytes = dataURLToUint8Array(pngDataURL);

      const icoBuffer = createIcoFromPng(pngBytes, size, size);
      const blob = new Blob([icoBuffer], { type: 'image/x-icon' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'icon_256.ico';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    function dataURLToUint8Array(dataURL) {
      const base64 = dataURL.split(',')[1];
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function createIcoFromPng(pngBytes, width, height) {
      const pngSize = pngBytes.length;
      const icoSize = 6 + 16 + pngSize;
      const buffer = new ArrayBuffer(icoSize);
      const view = new DataView(buffer);

      // ICONDIR
      view.setUint16(0, 0, true);   // idReserved
      view.setUint16(2, 1, true);   // idType = 1 (ICO)
      view.setUint16(4, 1, true);   // idCount = 1

      // ICONDIRENTRY
      view.setUint8(6, width === 256 ? 0 : width);   // bWidth
      view.setUint8(7, height === 256 ? 0 : height); // bHeight
      view.setUint8(8, 0);                           // bColorCount
      view.setUint8(9, 0);                           // bReserved
      view.setUint16(10, 1, true);                   // wPlanes
      view.setUint16(12, 32, true);                  // wBitCount
      view.setUint32(14, pngSize, true);             // dwBytesInRes
      view.setUint32(18, 6 + 16, true);              // dwImageOffset

      const byteArray = new Uint8Array(buffer, 22);
      byteArray.set(pngBytes);

      return buffer;
    }
  </script>
</body>
</html>

